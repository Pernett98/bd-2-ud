DROP SEQUENCE SEQ_ENTRADAS;

set serveroutput on;


CREATE SEQUENCE SEQ_ENTRADAS
increment by 1
start with 1
nocache
nocycle;

CREATE OR REPLACE TRIGGER TR_ENTRADAS
BEFORE INSERT ON ENTRADAS
FOR EACH ROW
DECLARE
  CANT_ENT_REG NUMBER;
  CANT_ENT_VEN NUMBER;
  CANTIDAD_ENTRADAS_E EXCEPTION;
BEGIN
  SELECT COUNT(*)
  INTO CANT_ENT_REG
  FROM ENTRADAS
  WHERE ID_VENTA = :new.ID_VENTA;

  SELECT (CANTIDAD_ENTRADAS)
  INTO CANT_ENT_VEN
  FROM VENTAS_ENTRADAS
  WHERE ID_VENTA = :new.ID_VENTA;

  IF (CANT_ENT_REG >= CANT_ENT_VEN) THEN
    RAISE CANTIDAD_ENTRADAS_E;
  END IF;

  SELECT SEQ_ENTRADAS.nextval
  INTO :new.ID_ENTRADA
  FROM dual;
EXCEPTION
  WHEN CANTIDAD_ENTRADAS_E THEN
    raise_application_error(-20000,'No se puede registrar la entrada, lo volqueta no tiene mas cupos de entradas');
END;
/
